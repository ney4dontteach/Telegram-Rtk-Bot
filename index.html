<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üß† –£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f3f3f3;
      color: #1c1c1c;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #3a86ff;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background-color: #3a86ff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #2a76ef;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
      border: 1px solid #c0e0ff;
    }
    .match {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß† –£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂</h1>

    <div class="form-group">
      <label>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx)</label>
      <input type="file" id="fileInput" accept=".xlsx, .xls" />
    </div>

    <div class="form-group">
      <label>1.1 –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç</label>
      <select id="sheetSelect" disabled>
        <option>–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</option>
      </select>
    </div>

    <div class="form-group">
      <label>2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –æ—Ñ–∏—Å –ø—Ä–æ–¥–∞–∂</label>
      <select id="officeSelect" disabled>
        <option>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç</option>
      </select>
    </div>

    <div class="form-group">
      <label>3. –¶–µ–ª–µ–≤–æ–π —Ä–æ—Å—Ç (%) –æ—Ç –ø–ª–∞–Ω–∞</label>
      <input type="number" id="growthInput" value="10" min="0" />
    </div>

    <div class="form-group">
      <label>4. –¶–µ–ª–µ–≤–∞—è –¥–∞—Ç–∞</label>
      <input type="date" id="dateInput" />
    </div>

    <button onclick="calculate()" disabled id="calcButton">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

    <div id="result"></div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    let allData = [];
    let workbook = null;

    // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ –æ—Ñ–∏—Å–∞
    const OFFICE_KEYWORDS = ['–º–∞–≥–∞–∑–∏–Ω', '–æ—Ñ–∏—Å', '–¥—Å', '–∞–¥—Ä–µ—Å', '–Ω–æ–º–µ—Ä', 'id', '—Ä–µ–≥–∏–æ–Ω', '–¥–∏–≤–∏–∑–∏–æ–Ω'];

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        workbook = XLSX.read(data, { type: 'array' });

        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        workbook.SheetNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          sheetSelect.appendChild(option);
        });

        sheetSelect.disabled = false;
        document.getElementById('result').innerHTML = '<p>‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç.</p>';
      };
      reader.readAsArrayBuffer(file);
    });

    // –ü—Ä–∏ —Å–º–µ–Ω–µ –ª–∏—Å—Ç–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    document.getElementById('sheetSelect').addEventListener('change', function() {
      const sheetName = this.value;
      const worksheet = workbook.Sheets[sheetName];
      allData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      if (allData.length < 2) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ –ª–∏—Å—Ç–µ.</p>';
        return;
      }

      // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏
      const headers = allData[0];
      const dataRows = allData.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = row[i];
        });
        return obj;
      });

      // –ò—â–µ–º –ø–∞—Ä—É –ü–ª–∞–Ω/–§–∞–∫—Ç –ø–æ —Å–º—ã—Å–ª—É
      const { plan: planCol, fact: factCol, baseName } = findMatchingPlanFact(headers);

      if (!planCol) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å "–ø–ª–∞–Ω–æ–º". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è.</p>';
        return;
      }
      if (!factCol) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å "—Ñ–∞–∫—Ç–æ–º" –¥–ª—è <b>' + baseName + '</b>. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ.</p>';
        return;
      }

      // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É –æ—Ñ–∏—Å–∞
      const officeCol = findColumn(headers, OFFICE_KEYWORDS);
      if (!officeCol) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å "–æ—Ñ–∏—Å–æ–º". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è.</p>';
        return;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º
      window.headers = headers;
      window.dataRows = dataRows;
      window.planCol = planCol;
      window.factCol = factCol;
      window.officeCol = officeCol;

      // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ñ–∏—Å—ã
      const offices = [...new Set(dataRows.map(row => row[officeCol]))].filter(Boolean).sort();

      const officeSelect = document.getElementById('officeSelect');
      officeSelect.innerHTML = '';
      offices.forEach(office => {
        const option = document.createElement('option');
        option.value = office;
        option.textContent = office;
        officeSelect.appendChild(option);
      });

      officeSelect.disabled = false;
      document.getElementById('calcButton').disabled = false;

      document.getElementById('result').innerHTML = `
        <p>‚úÖ –õ–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω.</p>
        <p class="match">üîß –ù–∞–π–¥–µ–Ω–æ: <b>${baseName || '–ø—Ä–æ–¥–∞–∂–∏'}</b></p>
        <p class="match">üìà –ü–ª–∞–Ω = <b>${planCol}</b></p>
        <p class="match">üìä –§–∞–∫—Ç = <b>${factCol}</b></p>
        <p class="match">üè¢ –û—Ñ–∏—Å = <b>${officeCol}</b></p>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ñ–∏—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å".</p>
      `;
    });

    // –£–º–Ω—ã–π –ø–æ–∏—Å–∫: –∏—â–µ—Ç –ø–∞—Ä—É –ü–ª–∞–Ω/–§–∞–∫—Ç –ø–æ –æ–±—â–µ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
    function findMatchingPlanFact(headers) {
      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –ø–∞—Ä–∞–º
      for (let header of headers) {
        if (!header) continue;
        const h = String(header).toLowerCase();

        // –ò—â–µ–º "–ü–ª–∞–Ω", –Ω–æ –Ω–µ "–§–∞–∫—Ç", –Ω–µ "%"
        if (
          (h.includes('–ø–ª–∞–Ω') || h.includes('planned') || h.includes('target')) &&
          !h.includes('—Ñ–∞–∫—Ç') &&
          !h.includes('actual') &&
          !h.includes('%') &&
          !h.includes('–≤—ã–ø–æ–ª–Ω')
        ) {
          // –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ "–ø–ª–∞–Ω" –∏ —á–∏—Å—Ç–∏–º
          let base = h
            .replace(/–ø–ª–∞–Ω|planned|target|plan|pl/gi, '')
            .replace(/\s+/g, ' ')
            .trim();

          if (base.length < 2) continue;

          // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É —Å "—Ñ–∞–∫—Ç" –∏ —Ç–µ–º –∂–µ base
          const factHeader = headers.find(h2 => {
            if (!h2) return false;
            const h2Str = String(h2).toLowerCase();
            return (
              (h2Str.includes('—Ñ–∞–∫—Ç') || h2Str.includes('actual') || h2Str.includes('—Ä–µ–∞–ª')) &&
              h2Str.includes(base)
            );
          });

          if (factHeader) {
            return {
              plan: header,
              fact: factHeader,
              baseName: base
            };
          }
        }
      }

      // –†–µ–∑–µ—Ä–≤: –ø—Ä–æ—Å—Ç–æ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
      const plan = findColumn(headers, ['–ø–ª–∞–Ω', 'planned', 'target']);
      const fact = findColumn(headers, ['—Ñ–∞–∫—Ç', 'actual', '—Ä–µ–∞–ª']);
      
      return {
        plan,
        fact,
        baseName: plan ? String(plan).replace(/–ø–ª–∞–Ω.*/i, '').trim() : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
      };
    }

    // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    function findColumn(headers, keywords) {
      for (let header of headers) {
        if (!header) continue;
        const h = String(header).toLowerCase();
        for (let kw of keywords) {
          if (h.includes(kw)) return header;
        }
      }
      return null;
    }

    // –†–∞—Å—á—ë—Ç
    function calculate() {
      const office = document.getElementById('officeSelect').value;
      const growthPercent = Number(document.getElementById('growthInput').value);
      const targetDateInput = document.getElementById('dateInput').value;

      if (!office || !targetDateInput) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ñ–∏—Å –∏ –¥–∞—Ç—É!');
        return;
      }

      const targetDate = new Date(targetDateInput);
      const growth = growthPercent / 100;

      const filtered = window.dataRows.filter(row => String(row[window.officeCol]) === String(office));
      if (filtered.length === 0) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –æ—Ñ–∏—Å–∞.</p>';
        return;
      }

      const totalPlan = filtered.reduce((sum, row) => sum + (parseFloat(row[window.planCol]) || 0), 0);
      const totalFact = filtered.reduce((sum, row) => sum + (parseFloat(row[window.factCol]) || 0), 0);

      const target = totalPlan * (1 + growth);
      const remaining = target - totalFact;

      const today = new Date();
      const daysLeft = Math.max(1, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)));
      const dailyTarget = (remaining / daysLeft).toFixed(0);

      const completion = totalPlan > 0 ? ((totalFact / totalPlan) * 100).toFixed(1) : 0;

      document.getElementById('result').innerHTML = `
        <h3>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: <b>–û—Ñ–∏—Å ${office}</b></h3>
        <p><b>–ü–ª–∞–Ω:</b> ${totalPlan.toLocaleString()} ‚ÇΩ</p>
        <p><b>–§–∞–∫—Ç:</b> ${totalFact.toLocaleString()} ‚ÇΩ</p>
        <p><b>% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</b> <span style="color: ${completion >= 100 ? 'green' : 'orange'}">${completion}%</span></p>
        <p><b>–¶–µ–ª—å (+${growthPercent}%):</b> ${target.toLocaleString()} ‚ÇΩ</p>
        <p><b>–û—Å—Ç–∞–ª–æ—Å—å:</b> <span style="color: ${remaining > 0 ? 'red' : 'green'}; font-weight: bold;">${remaining.toLocaleString()} ‚ÇΩ</span></p>
        <p><b>–î–Ω–µ–π –¥–æ –¥–∞—Ç—ã:</b> ${daysLeft}</p>
        <p><b>–ù—É–∂–Ω–æ –≤ –¥–µ–Ω—å:</b> ${dailyTarget.replace(/\B(?=(\d{3})+(?!\d))/g, " ")} ‚ÇΩ</p>
      `;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateInput').value = today;
    };
  </script>
</body>
</html>
