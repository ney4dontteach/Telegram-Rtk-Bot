<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä –ú—É–ª—å—Ç–∏-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f3f3f3;
      color: #1c1c1c;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #3a86ff;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background-color: #3a86ff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    .target-row {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .match {
      font-size: 14px;
      color: #555;
    }
    #result {
      margin-top: 20px;
    }
    .result-item {
      margin-bottom: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
      border: 1px solid #c0e0ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä –ú—É–ª—å—Ç–∏-–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂</h1>

    <div class="form-group">
      <label>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx)</label>
      <input type="file" id="fileInput" accept=".xlsx, .xls" />
    </div>

    <div class="form-group">
      <label>1.1 –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç</label>
      <select id="sheetSelect" disabled>
        <option>–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</option>
      </select>
    </div>

    <div class="form-group">
      <label>1.2 –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ñ–∏—Å –ø—Ä–æ–¥–∞–∂</label>
      <select id="officeSelect" disabled>
        <option>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç</option>
      </select>
    </div>

    <div id="targets-container">
      <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ü–µ–ª–∏ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π -->
    </div>

    <button onclick="addTargetRow()" disabled id="addButton">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    <button onclick="calculateAll()" disabled id="calcButton" style="margin-top: 10px;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>

    <div id="result"></div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    let allData = [];
    let workbook = null;
    let directions = []; // { name, planCol, factCol }
    let officeCol = null;

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        workbook = XLSX.read(data, { type: 'array' });

        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        workbook.SheetNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          sheetSelect.appendChild(option);
        });

        sheetSelect.disabled = false;
        document.getElementById('result').innerHTML = '<p>‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç.</p>';
      };
      reader.readAsArrayBuffer(file);
    });

    // –ü—Ä–∏ —Å–º–µ–Ω–µ –ª–∏—Å—Ç–∞
    document.getElementById('sheetSelect').addEventListener('change', function() {
      const sheetName = this.value;
      const worksheet = workbook.Sheets[sheetName];
      allData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      if (allData.length < 2) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö.</p>';
        return;
      }

      const headers = allData[0];
      const dataRows = allData.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => { obj[h] = row[i]; });
        return obj;
      });

      // –ù–∞–π–¥—ë–º –≤—Å–µ –ø–∞—Ä—ã –ü–ª–∞–Ω/–§–∞–∫—Ç
      directions = findAllPlanFactPairs(headers);
      if (directions.length === 0) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –ø–∞—Ä—ã –ü–ª–∞–Ω/–§–∞–∫—Ç.</p>';
        return;
      }

      // –ù–∞–π–¥—ë–º –∫–æ–ª–æ–Ω–∫—É –æ—Ñ–∏—Å–∞
      officeCol = findColumn(headers, ['–º–∞–≥–∞–∑–∏–Ω', '–æ—Ñ–∏—Å', '–¥—Å', '–∞–¥—Ä–µ—Å', '–Ω–æ–º–µ—Ä', 'id']);
      if (!officeCol) {
        document.getElementById('result').innerHTML = '<p style="color: red">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å –æ—Ñ–∏—Å–æ–º.</p>';
        return;
      }

      // –ó–∞–ø–æ–ª–Ω–∏–º –æ—Ñ–∏—Å—ã
      const offices = [...new Set(dataRows.map(row => row[officeCol]))].filter(Boolean).sort();
      const officeSelect = document.getElementById('officeSelect');
      officeSelect.innerHTML = '';
      offices.forEach(office => {
        const option = document.createElement('option');
        option.value = office;
        option.textContent = office;
        officeSelect.appendChild(option);
      });

      officeSelect.disabled = false;
      document.getElementById('addButton').disabled = false;
      document.getElementById('result').innerHTML = `
        <p>‚úÖ –õ–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω.</p>
        <p class="match">üîß –ù–∞–π–¥–µ–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π: <b>${directions.length}</b></p>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ñ–∏—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ".</p>
      `;
    });

    // –ù–∞–π—Ç–∏ –≤—Å–µ –ø–∞—Ä—ã –ü–ª–∞–Ω/–§–∞–∫—Ç
    function findAllPlanFactPairs(headers) {
      const pairs = [];
      const used = new Set();

      headers.forEach(h => {
        if (!h || used.has(h)) return;
        const hStr = String(h).toLowerCase();

        if (
          (hStr.includes('–ø–ª–∞–Ω') || hStr.includes('target')) &&
          !hStr.includes('—Ñ–∞–∫—Ç') &&
          !hStr.includes('%') &&
          !hStr.includes('–≤—ã–ø–æ–ª–Ω')
        ) {
          const base = hStr
            .replace(/–ø–ª–∞–Ω|target|planned/g, '')
            .replace(/\s+/g, ' ')
            .trim();

          if (base.length === 0) return;

          const factCol = headers.find(h2 => {
            if (!h2 || used.has(h2)) return false;
            const h2Str = String(h2).toLowerCase();
            return (
              (h2Str.includes('—Ñ–∞–∫—Ç') || h2Str.includes('actual') || h2Str.includes('—Ä–µ–∞–ª')) &&
              h2Str.includes(base)
            );
          });

          if (factCol) {
            pairs.push({
              name: h.replace(/–ø–ª–∞–Ω|target/i, '').trim(),
              planCol: h,
              factCol: factCol
            });
            used.add(h);
            used.add(factCol);
          }
        }
      });

      // –†–µ–∑–µ—Ä–≤: –ø—Ä–æ—Å—Ç–æ –Ω–∞–π—Ç–∏ –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ —Å "–ø–ª–∞–Ω" –∏ "—Ñ–∞–∫—Ç"
      if (pairs.length === 0) {
        const planCols = headers.filter(h => h && /–ø–ª–∞–Ω|target/i.test(String(h)) && !/—Ñ–∞–∫—Ç|%|–≤—ã–ø–æ–ª–Ω/i.test(String(h)));
        const factCols = headers.filter(h => h && /—Ñ–∞–∫—Ç|actual|—Ä–µ–∞–ª/i.test(String(h)));

        planCols.forEach(plan => {
          const base = String(plan).toLowerCase().replace(/–ø–ª–∞–Ω|target/, '').trim();
          const fact = factCols.find(f => String(f).toLowerCase().includes(base));
          if (fact) {
            pairs.push({
              name: plan.replace(/–ø–ª–∞–Ω|target/i, '').trim(),
              planCol: plan,
              factCol: fact
            });
          }
        });
      }

      return pairs;
    }

    // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –∫–æ–ª–æ–Ω–∫–∏
    function findColumn(headers, keywords) {
      for (let header of headers) {
        if (!header) continue;
        const h = String(header).toLowerCase();
        for (let kw of keywords) {
          if (h.includes(kw)) return header;
        }
      }
      return null;
    }

    // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function addTargetRow() {
      const container = document.getElementById('targets-container');
      const row = document.createElement('div');
      row.className = 'target-row';

      row.innerHTML = `
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
        <select class="direction-select">
          ${directions.map(d => `<option value="${d.planCol}">${d.name}</option>`).join('')}
        </select>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <div style="flex: 1;">
            <label>–¶–µ–ª—å (%)</label>
            <input type="number" value="10" min="0" class="growth-input" />
          </div>
          <div style="flex: 1;">
            <label>–î–∞—Ç–∞</label>
            <input type="date" class="date-input" />
          </div>
        </div>
        <button type="button" onclick="this.parentElement.remove()" style="margin-top: 10px; background: #e74c3c;">üóë –£–¥–∞–ª–∏—Ç—å</button>
      `;

      container.appendChild(row);

      // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
      const dateInput = row.querySelector('.date-input');
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;

      document.getElementById('calcButton').disabled = false;
    }

    // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function calculateAll() {
      const office = document.getElementById('officeSelect').value;
      const targetRows = document.querySelectorAll('.target-row');
      const resultDiv = document.getElementById('result');
      
      if (targetRows.length === 0) {
        resultDiv.innerHTML = '<p>–ù–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</p>';
        return;
      }

      const dataRows = allData.slice(1).map(row => {
        const obj = {};
        allData[0].forEach((h, i) => { obj[h] = row[i]; });
        return obj;
      });

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
      const tableRows = [];

      targetRows.forEach(row => {
        const planCol = row.querySelector('.direction-select').value;
        const growth = Number(row.querySelector('.growth-input').value) / 100;
        const targetDate = new Date(row.querySelector('.date-input').value);

        const direction = directions.find(d => d.planCol === planCol);
        if (!direction) return;

        const filtered = dataRows.filter(r => String(r[officeCol]) === String(office));
        const totalPlan = filtered.reduce((sum, r) => sum + (parseFloat(r[direction.planCol]) || 0), 0);
        const totalFact = filtered.reduce((sum, r) => sum + (parseFloat(r[direction.factCol]) || 0), 0);

        const target = totalPlan * (1 + growth);
        const remaining = target - totalFact;
        const today = new Date();
        const daysLeft = Math.max(1, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)));
        const dailyTarget = (remaining / daysLeft).toFixed(0);
        const completion = totalPlan > 0 ? ((totalFact / totalPlan) * 100) : 0;
        const dailyPlan = (totalPlan / 30).toFixed(0); // –°—Ä–µ–¥–Ω–∏–π –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω (–Ω–∞ 30 –¥–Ω–µ–π)
        const forecast = ((totalFact / totalPlan) * 100).toFixed(1);
        const diff = totalFact - totalPlan; // –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ/–ø–µ—Ä–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

        tableRows.push({
          name: direction.name,
          totalPlan: totalPlan.toLocaleString(),
          dailyPlan: dailyPlan.replace(/\B(?=(\d{3})+(?!\d))/g, " "),
          fact: totalFact.toLocaleString(),
          forecast: `${forecast}%`,
          diff: diff >= 0 
            ? `<span style="color: green">+${diff.toLocaleString()} ‚ÇΩ</span>` 
            : `<span style="color: red">${diff.toLocaleString()} ‚ÇΩ</span>`,
          dailyTarget: dailyTarget.replace(/\B(?=(\d{3})+(?!\d))/g, " ")
        });
      });

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
      let tableHTML = `
        <h3>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –æ—Ñ–∏—Å–∞: ${office}</h3>
        <table border="1" cellpadding="8" cellspacing="0" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
          <thead>
            <tr style="background: #3a86ff; color: white;">
              <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
              <th>–ü–ª–∞–Ω –º–µ—Å—è—Ü–∞</th>
              <th>–°—Ä–µ–¥–Ω–∏–π –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω</th>
              <th>–§–∞–∫—Ç</th>
              <th>–¢–µ–∫—É—â–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø—Ä–æ–≥–Ω–æ–∑)</th>
              <th>–û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ/–ü–µ—Ä–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</th>
              <th>–ù—É–∂–Ω–æ –≤ –¥–µ–Ω—å</th>
            </tr>
          </thead>
          <tbody>
      `;

      tableRows.forEach(row => {
        tableHTML += `
          <tr style="text-align: center; border-bottom: 1px solid #ddd;">
            <td style="font-weight: bold;"><b>${row.name}</b></td>
            <td>${row.totalPlan} ‚ÇΩ</td>
            <td>${row.dailyPlan} ‚ÇΩ</td>
            <td>${row.fact} ‚ÇΩ</td>
            <td>${row.forecast}</td>
            <td>${row.diff}</td>
            <td><b>${row.dailyTarget} ‚ÇΩ</b></td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
        <p style="margin-top: 15px; font-size: 12px; color: #777;">
          <i>üí° –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø–æ —Ñ–∞–∫—Ç—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. "–ù—É–∂–Ω–æ –≤ –¥–µ–Ω—å" ‚Äî —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏ –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç–µ.</i>
        </p>
      `;

      resultDiv.innerHTML = tableHTML;
    }
  </script>
</body>
</html>
